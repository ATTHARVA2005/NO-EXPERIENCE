# ğŸ” Authentication System Guide

## âœ… Complete Authentication Flow

### 1. **Sign Up Process**
When a user signs up:
1. Supabase Auth creates a new user with a **random UUID**
2. The UUID is automatically generated by Supabase (e.g., `70678d7b-4688-452e-b91a-4be0a7f13dc1`)
3. User data is inserted into the `students` table with:
   - `id`: The UUID from Supabase Auth
   - `name`: User's full name
   - `email`: User's email address
   - `grade_level`: Grade (default: 9)
   - `learning_style`: Learning preference (default: 'visual')
   - `average_score`: Performance metric (default: 0)

### 2. **Sign In Process**
When a user signs in:
1. Credentials are verified by Supabase Auth
2. System checks if student profile exists in database
3. If missing, creates profile automatically
4. Redirects to dashboard

### 3. **Sign Out Process**
When a user signs out:
1. Supabase session is cleared
2. User is redirected to login page
3. Protected routes become inaccessible

---

## ğŸ¯ Quick Start

### Test the Authentication

1. **Sign Up a New User**:
   ```
   http://localhost:3000/login
   ```
   - Click "Sign Up" tab
   - Enter: Name, Email, Password, Grade
   - Click "Sign Up"
   - Success message appears
   - User is created with random UUID

2. **Sign In**:
   - Enter your email and password
   - Click "Sign In"
   - Redirected to `/dashboard`

3. **Sign Out**:
   - Click "Sign Out" button in sidebar
   - Redirected to `/login`

---

## ğŸ”§ Supabase Configuration

### Disable Email Confirmation (for Development)

To allow immediate sign-in without email confirmation:

1. Go to **Supabase Dashboard** â†’ Your Project
2. Navigate to **Authentication** â†’ **Settings**
3. Find **Email Auth** section
4. **Disable "Enable email confirmations"**
5. Click **Save**

### Enable RLS Policies

Make sure Row Level Security policies are enabled:

```sql
-- Run this in Supabase SQL Editor:
ALTER TABLE students ENABLE ROW LEVEL SECURITY;

-- Allow users to read their own data
CREATE POLICY "Users can view own profile" ON students
  FOR SELECT USING (auth.uid() = id);

-- Allow users to update their own data
CREATE POLICY "Users can update own profile" ON students
  FOR UPDATE USING (auth.uid() = id);

-- Allow users to insert their own profile
CREATE POLICY "Users can insert own profile" ON students
  FOR INSERT WITH CHECK (auth.uid() = id);
```

---

## ğŸ“Š Database Schema

### Students Table Structure

```sql
CREATE TABLE students (
  id UUID PRIMARY KEY,                    -- Supabase Auth UUID
  name TEXT NOT NULL,                     -- User's full name
  email TEXT NOT NULL UNIQUE,             -- User's email
  grade_level INTEGER DEFAULT 9,          -- Grade (1-12)
  learning_style TEXT DEFAULT 'visual',   -- Learning preference
  average_score NUMERIC(5,2) DEFAULT 0,   -- Performance metric
  created_at TIMESTAMP DEFAULT now(),     -- Account creation
  updated_at TIMESTAMP DEFAULT now()      -- Last update
);
```

---

## ğŸ›¡ï¸ Security Features

### Protected Routes
All dashboard routes are protected by middleware:
- `/dashboard/*` - Requires authentication
- `/api/*` - Some endpoints require auth
- `/login` - Public (redirects to dashboard if logged in)
- `/` - Public landing page

### Session Management
- Sessions stored in HTTP-only cookies
- Auto-refresh when expired
- Secure token handling

---

## ğŸ§ª Testing Authentication

### Test Account
You can use the existing test account:
- **Email**: `tamo.roy@example.com`
- **Password**: `password123`
- **ID**: `70678d7b-4688-452e-b91a-4be0a7f13dc1`

Or create your own by signing up!

---

## ğŸ› Troubleshooting

### "Invalid login credentials"
- **Cause**: Wrong email/password
- **Fix**: Double-check credentials or reset password

### "Email not confirmed"
- **Cause**: Email confirmation required
- **Fix**: Disable email confirmation in Supabase settings (see above)

### "Profile creation failed"
- **Cause**: RLS policies blocking insert
- **Fix**: Run the RLS policy SQL above

### User can't access dashboard
- **Cause**: No student profile in database
- **Fix**: Sign in again (auto-creates profile)

---

## ğŸ“ Implementation Details

### Files Modified

1. **`app/(auth)/login/page.tsx`**
   - Enhanced sign-up with better error handling
   - Auto-creates student profile with UUID
   - Improved user feedback

2. **`app/api/auth/callback/route.ts`**
   - Handles OAuth callback
   - Auto-creates missing profiles
   - Comprehensive logging

3. **`middleware.ts` + `lib/supabase/middleware.ts`**
   - Protects routes
   - Manages sessions
   - Handles redirects

4. **`components/sidebar.tsx`**
   - Sign-out functionality
   - Session management

---

## ğŸ¨ User Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Landing   â”‚
â”‚    Page     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Login    â”‚ â†â”€â”€â”€â”€â”€â”€â”
â”‚    Page     â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
       â”‚               â”‚
       â†“               â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
  â”‚Sign Up?â”‚           â”‚
  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â”‚
      â”‚ Yes            â”‚
      â†“                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  Create     â”‚        â”‚
â”‚  Account    â”‚        â”‚
â”‚  + UUID     â”‚        â”‚
â”‚  + Profile  â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
       â”‚               â”‚
       â†“               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   Sign In   â”‚        â”‚
â”‚   Success   â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
       â”‚               â”‚
       â†“               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  Dashboard  â”‚        â”‚
â”‚             â”‚        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚ â”‚Sign Out?â”‚ â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚      â”‚      â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜        â”‚
       â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Summary

- âœ… **Random UUID** automatically generated by Supabase
- âœ… **Student profile** auto-created on sign-up
- âœ… **Sign-in** with email/password
- âœ… **Sign-out** functionality working
- âœ… **Protected routes** via middleware
- âœ… **Auto-recovery** creates missing profiles
- âœ… **Comprehensive logging** for debugging

The authentication system is **fully functional** and ready to use!
